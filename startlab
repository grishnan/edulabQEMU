#!/bin/bash
# Author: grishnan https://github.com/grishnan
# E-mail: grishnan@gmail.com
# License: GNU GENERAL PUBLIC LICENSE Version 3

mdir=machines # machines directory
switch=br0    # bridge name

if ! ip -br -f link -c a | awk '{ print $1 }' | grep $switch > /dev/null 2>&1; then
  ip link add $switch type bridge
fi
ip link set $switch up

function genmac {
  echo "$(printf '00:60:2F:%02X:%02X:%02X\n' $[RANDOM%256] $[RANDOM%256] $[RANDOM%256])"
}

function startmachine {
  qemu-system-x86_64 -name $1 -enable-kvm -accel kvm -machine q35,kernel_irqchip=on,vmport=off \
                     -cpu host -smp cores=$2 -boot order=c -drive file=$mdir/$1.img,format=raw -m size=$3M $5 \
                     -device virtio-net,netdev=$4,mac=$(genmac) -netdev tap,id=$4,script=./qemu-ifup,downscript=./qemu-ifdown &
}

# startmachine <machine name> <cores> <memory in MB> <lan id>
startmachine CLI-C 2 200 lan0
startmachine CLI-P 2 200 lan0
startmachine SRV   2 200 lan0 "-device e1000,netdev=wan0,mac=$(genmac) -netdev user,id=wan0"
